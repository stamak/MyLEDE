
- name: Install and configure storage
  hosts: lede
  gather_facts: no
  tasks:
    - name: install storage packages
      action: >
        opkg name={{ item }} state=present update_cache=yes
      with_items:
        - kmod-usb-storage
        - kmod-scsi-core
        - kmod-fs-ext4
        - e2fsprogs
        - block-mount
    - name: create dir 1
      file:
        path: /storage/1
        state: directory
    - name: create dir 2
      file:
        path: /storage/2
        state: directory
    - name: copy fstab file
      copy: src=files/fstab dest=/etc/config/fstab owner=root mode=0640
    - name: fstab service
      raw: /sbin/block mount
    - name: copy wait4mount file
      copy: src=files/wait4mount dest=/etc/init.d/wait4mount owner=root mode=0751
      #- name: enable wait4mount
      #raw: /etc/init.d/wait4mount enable
    - name: install SAMBA
      opkg: name=samba36-server state=present
    - name: copy samba file
      copy: src=files/samba dest=/etc/config/samba owner=root mode=0640
      notify: enable and start samba

  handlers:
    - name: enable and start samba
      raw: /etc/init.d/samba restart && /etc/init.d/samba enable
